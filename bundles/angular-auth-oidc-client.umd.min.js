!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/core"),require("@angular/common/http"),require("rxjs"),require("jsrsasign-reduced"),require("rxjs/operators"),require("common-tags"),require("@angular/router")):"function"==typeof define&&define.amd?define("angular-auth-oidc-client",["exports","@angular/common","@angular/core","@angular/common/http","rxjs","jsrsasign-reduced","rxjs/operators","common-tags","@angular/router"],t):t((e=e||self)["angular-auth-oidc-client"]={},e.ng.common,e.ng.core,e.ng.common.http,e.rxjs,e["jsrsasign-reduced"],e.rxjs.operators,e["common-tags"],e.ng.router)}(this,(function(e,t,r,i,n,o,s,a,c){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var u=function(){return(u=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function l(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}function h(e,t){return function(r,i){t(r,i,e)}}function d(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],i=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function g(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var i,n,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s}function p(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var f,v=function(){function e(e){this.http=e}return e.prototype.get=function(e,t){return this.http.get(e,t)},e.prototype.post=function(e,t,r){return this.http.post(e,t,r)},e.ctorParameters=function(){return[{type:i.HttpClient}]},e=l([r.Injectable()],e)}(),S=function(){function e(e){this.httpClient=e}return e.prototype.get=function(e,t){var r=this.prepareHeaders(t);return this.httpClient.get(e,{headers:r})},e.prototype.post=function(e,t,r){var i=r||this.prepareHeaders();return this.httpClient.post(e,t,{headers:i})},e.prototype.prepareHeaders=function(e){var t=new i.HttpHeaders;return t=t.set("Accept","application/json"),e&&(t=t.set("Authorization","Bearer "+decodeURIComponent(e))),t},e.ctorParameters=function(){return[{type:v}]},e=l([r.Injectable()],e)}(),y=function(){function e(e){this.platformId=e}return Object.defineProperty(e.prototype,"isBrowser",{get:function(){return t.isPlatformBrowser(this.platformId)},enumerable:!0,configurable:!0}),e.ctorParameters=function(){return[{type:String,decorators:[{type:r.Inject,args:[r.PLATFORM_ID]}]}]},e=l([r.Injectable(),h(0,r.Inject(r.PLATFORM_ID))],e)}();(f=e.LogLevel||(e.LogLevel={}))[f.Debug=0]="Debug",f[f.Warn=1]="Warn",f[f.Error=2]="Error";var w,k={stsServer:"https://please_set",authWellknownEndpoint:"",redirectUrl:"https://please_set",clientId:"please_set",responseType:"code",scope:"openid email profile",hdParam:"",postLogoutRedirectUri:"https://please_set",startCheckSession:!1,silentRenew:!1,silentRenewUrl:"https://please_set",renewTimeBeforeTokenExpiresInSeconds:0,useRefreshToken:!1,ignoreNonceAfterRefresh:!1,postLoginRoute:"/",forbiddenRoute:"/forbidden",unauthorizedRoute:"/unauthorized",autoUserinfo:!0,autoCleanStateAfterAuthentication:!0,triggerAuthorizationResultEvent:!1,logLevel:e.LogLevel.Warn,issValidationOff:!1,historyCleanupOff:!1,maxIdTokenIatOffsetAllowedInSeconds:120,disableIatOffsetValidation:!1,storage:"undefined"!=typeof Storage?sessionStorage:null,customParams:{},disableRefreshIdTokenAuthTimeValidation:!1},I=function(){function e(e){this.platformProvider=e}return Object.defineProperty(e.prototype,"openIDConfiguration",{get:function(){return this.openIdConfigurationInternal?this.openIdConfigurationInternal:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"wellKnownEndpoints",{get:function(){return this.wellKnownEndpointsInternal?this.wellKnownEndpointsInternal:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"configuration",{get:function(){return this.hasValidConfig()?{configuration:u({},this.openIDConfiguration),wellknown:u({},this.wellKnownEndpoints)}:null},enumerable:!0,configurable:!0}),e.prototype.hasValidConfig=function(){return!!this.wellKnownEndpointsInternal&&!!this.openIdConfigurationInternal},e.prototype.setConfig=function(e,t){this.wellKnownEndpointsInternal=t,this.openIdConfigurationInternal=u(u({},k),e),(null==e?void 0:e.storage)&&console.warn("PLEASE NOTE: The storage in the config will be deprecated in future versions: Please pass the custom storage in forRoot() as documented"),this.setSpecialCases(this.openIdConfigurationInternal)},e.prototype.setSpecialCases=function(e){this.platformProvider.isBrowser||(e.startCheckSession=!1,e.silentRenew=!1,e.useRefreshToken=!1)},e.ctorParameters=function(){return[{type:y}]},e=l([r.Injectable()],e)}(),b=function(){function t(e){this.configurationProvider=e}return t.prototype.logError=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];t.length?console.error(e,t):console.error(e)},t.prototype.logWarning=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.currentLogLevelIsEqualOrSmallerThan(e.LogLevel.Warn)&&(r.length?console.warn(t,r):console.warn(t))},t.prototype.logDebug=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.currentLogLevelIsEqualOrSmallerThan(e.LogLevel.Debug)&&(r.length?console.log(t,r):console.log(t))},t.prototype.currentLogLevelIsEqualOrSmallerThan=function(e){return this.configurationProvider.openIDConfiguration.logLevel<=e},t.ctorParameters=function(){return[{type:I}]},t=l([r.Injectable()],t)}();(w=e.EventTypes||(e.EventTypes={}))[w.ConfigLoaded=0]="ConfigLoaded",w[w.CheckSessionReceived=1]="CheckSessionReceived",w[w.UserDataChanged=2]="UserDataChanged",w[w.NewAuthorizationResult=3]="NewAuthorizationResult",w[w.TokenExpired=4]="TokenExpired",w[w.IdTokenExpired=5]="IdTokenExpired";var R,m=function(){function e(){this.notify=new n.ReplaySubject(1)}return e.prototype.fireEvent=function(e,t){this.notify.next({type:e,value:t})},e.prototype.registerForEvents=function(){return this.notify.asObservable()},e=l([r.Injectable()],e)}();(R=e.AuthorizedState||(e.AuthorizedState={})).Authorized="Authorized",R.Unauthorized="Unauthorized",R.Unknown="Unknown";var E=function(){function e(){}return e=l([r.Injectable()],e)}(),C=function(){function t(e,t){this.oidcSecurityStorage=e,this.configurationProvider=t,this.storageAuthResult="authorizationResult",this.storageAccessToken="authorizationData",this.storageIdToken="authorizationDataIdToken",this.storageAuthorizedState="storageAuthorizedState",this.storageUserData="userData",this.storageAuthNonce="authNonce",this.storageCodeVerifier="codeVerifier",this.storageAuthStateControl="authStateControl",this.storageSessionState="session_state",this.storageSilentRenewRunning="storageSilentRenewRunning",this.storageAccessTokenExpiresIn="access_token_expires_at"}return Object.defineProperty(t.prototype,"authResult",{get:function(){return this.retrieve(this.storageAuthResult)},set:function(e){var t;this.store(this.storageAuthResult,e);var r=null===(t=this.authResult)||void 0===t?void 0:t.expires_in;if(r){var i=(new Date).valueOf()+1e3*r;this.accessTokenExpiresIn=i}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"accessToken",{get:function(){return this.retrieve(this.storageAccessToken)||""},set:function(e){this.store(this.storageAccessToken,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"idToken",{get:function(){return this.retrieve(this.storageIdToken)||""},set:function(e){this.store(this.storageIdToken,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authorizedState",{get:function(){return this.retrieve(this.storageAuthorizedState)},set:function(e){this.store(this.storageAuthorizedState,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userData",{get:function(){return this.retrieve(this.storageUserData)},set:function(e){this.store(this.storageUserData,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authNonce",{get:function(){return this.retrieve(this.storageAuthNonce)||""},set:function(e){this.store(this.storageAuthNonce,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"codeVerifier",{get:function(){return this.retrieve(this.storageCodeVerifier)||""},set:function(e){this.store(this.storageCodeVerifier,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"authStateControl",{get:function(){return this.retrieve(this.storageAuthStateControl)||""},set:function(e){this.store(this.storageAuthStateControl,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sessionState",{get:function(){return this.retrieve(this.storageSessionState)},set:function(e){this.store(this.storageSessionState,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"silentRenewRunning",{get:function(){return this.retrieve(this.storageSilentRenewRunning)||""},set:function(e){this.store(this.storageSilentRenewRunning,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"accessTokenExpiresIn",{get:function(){return this.retrieve(this.storageAccessTokenExpiresIn)},set:function(e){this.store(this.storageAccessTokenExpiresIn,e)},enumerable:!0,configurable:!0}),t.prototype.retrieve=function(e){var t=this.createKeyWithPrefix(e);return this.oidcSecurityStorage.read(t)},t.prototype.store=function(e,t){var r=this.createKeyWithPrefix(e);this.oidcSecurityStorage.write(r,t)},t.prototype.resetStorageFlowData=function(){this.store(this.storageSessionState,""),this.store(this.storageSilentRenewRunning,""),this.store(this.storageCodeVerifier,""),this.store(this.storageUserData,"")},t.prototype.resetAuthStateInStorage=function(){this.store(this.storageAuthorizedState,e.AuthorizedState.Unknown),this.store(this.storageAccessToken,""),this.store(this.storageIdToken,""),this.store(this.storageAuthResult,"")},t.prototype.getAccessToken=function(){return this.retrieve(this.storageAccessToken)},t.prototype.getIdToken=function(){return this.retrieve(this.storageIdToken)},t.prototype.getRefreshToken=function(){var e;return null===(e=this.authResult)||void 0===e?void 0:e.refresh_token},t.prototype.createKeyWithPrefix=function(e){return this.configurationProvider.openIDConfiguration.clientId+"_"+e},t.ctorParameters=function(){return[{type:E},{type:I}]},t=l([r.Injectable()],t)}(),T=function(){function e(e){this.configurationProvider=e}return e.prototype.isCurrentFlowCodeFlow=function(){return this.currentFlowIs("code")},e.prototype.isCurrentFlowAnyImplicitFlow=function(){return this.isCurrentFlowImplicitFlowWithAccessToken()||this.isCurrentFlowImplicitFlowWithoutAccessToken()},e.prototype.isCurrentFlowCodeFlowWithRefeshTokens=function(){return!(!this.isCurrentFlowCodeFlow()||!this.configurationProvider.openIDConfiguration.useRefreshToken)},e.prototype.isCurrentFlowImplicitFlowWithAccessToken=function(){return this.currentFlowIs("id_token token")},e.prototype.isCurrentFlowImplicitFlowWithoutAccessToken=function(){return this.currentFlowIs("id_token")},e.prototype.currentFlowIs=function(e){var t=this.configurationProvider.openIDConfiguration.responseType;return Array.isArray(e)?e.some((function(e){return t===e})):t===e},e.ctorParameters=function(){return[{type:I}]},e=l([r.Injectable()],e)}(),P=function(){function e(e){this.loggerService=e,this.PARTS_OF_TOKEN=3}return e.prototype.getTokenExpirationDate=function(e){if(!e.hasOwnProperty("exp"))return new Date;var t=new Date(0);return t.setUTCSeconds(e.exp),t},e.prototype.getHeaderFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,0,t):{}},e.prototype.getPayloadFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,1,t):{}},e.prototype.getSignatureFromToken=function(e,t){return this.tokenIsValid(e)?this.getPartOfToken(e,2,t):{}},e.prototype.getPartOfToken=function(e,t,r){var i=this.extractPartOfToken(e,t);if(r)return i;var n=this.urlBase64Decode(i);return JSON.parse(n)},e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("Illegal base64url string!")}var r="undefined"!=typeof window?window.atob(t):Buffer.from(t,"base64").toString("binary");try{return decodeURIComponent(r.split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}catch(e){return r}},e.prototype.tokenIsValid=function(e){return e?e.includes(".")?e.split(".").length===this.PARTS_OF_TOKEN||(this.loggerService.logError("token '"+e+"' is not valid --\x3e token has to have exactly "+this.PARTS_OF_TOKEN+" dots"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e no dots included"),!1):(this.loggerService.logError("token '"+e+"' is not valid --\x3e token falsy"),!1)},e.prototype.extractPartOfToken=function(e,t){return e.split(".")[t]},e.ctorParameters=function(){return[{type:b}]},e=l([r.Injectable()],e)}(),A=function(){function e(e,t,r){this.tokenHelperService=e,this.flowHelper=t,this.loggerService=r,this.keyAlgorithms=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","PS256","PS384","PS512"]}var t;return t=e,e.prototype.hasIdTokenExpired=function(e,t){var r;return r=this.tokenHelperService.getPayloadFromToken(e,!1),!this.validateIdTokenExpNotExpired(r,t)},e.prototype.validateIdTokenExpNotExpired=function(e,t){var r=this.tokenHelperService.getTokenExpirationDate(e);if(t=t||0,!r)return!1;var i=r.valueOf(),n=(new Date).valueOf()+1e3*t,o=i>n;return this.loggerService.logDebug("Has id_token expired: "+!o+", "+i+" > "+n),o},e.prototype.validateAccessTokenNotExpired=function(e,t){if(!e)return!0;t=t||0;var r=e.valueOf(),i=(new Date).valueOf()+1e3*t,n=r>i;return this.loggerService.logDebug("Has access_token expired: "+!n+", "+r+" > "+i),n},e.prototype.validateRequiredIdToken=function(e){var t=!0;return e.hasOwnProperty("iss")||(t=!1,this.loggerService.logWarning("iss is missing, this is required in the id_token")),e.hasOwnProperty("sub")||(t=!1,this.loggerService.logWarning("sub is missing, this is required in the id_token")),e.hasOwnProperty("aud")||(t=!1,this.loggerService.logWarning("aud is missing, this is required in the id_token")),e.hasOwnProperty("exp")||(t=!1,this.loggerService.logWarning("exp is missing, this is required in the id_token")),e.hasOwnProperty("iat")||(t=!1,this.loggerService.logWarning("iat is missing, this is required in the id_token")),t},e.prototype.validateIdTokenIatMaxOffset=function(e,t,r){if(r)return!0;if(!e.hasOwnProperty("iat"))return!1;var i=new Date(0);if(i.setUTCSeconds(e.iat),t=t||0,null==i)return!1;this.loggerService.logDebug("validate_id_token_iat_max_offset: "+((new Date).valueOf()-i.valueOf())+" < "+1e3*t);var n=(new Date).valueOf()-i.valueOf();return n>0?n<1e3*t:-n<1e3*t},e.prototype.validateIdTokenNonce=function(e,r,i){return!((void 0!==e.nonce&&!i||r!==t.RefreshTokenNoncePlaceholder)&&e.nonce!==r)||(this.loggerService.logDebug("Validate_id_token_nonce failed, dataIdToken.nonce: "+e.nonce+" local_nonce:"+r),!1)},e.prototype.validateIdTokenIss=function(e,t){return e.iss===t||(this.loggerService.logDebug("Validate_id_token_iss failed, dataIdToken.iss: "+e.iss+" authWellKnownEndpoints issuer:"+t),!1)},e.prototype.validateIdTokenAud=function(e,t){return Array.isArray(e.aud)?!!e.aud.includes(t)||(this.loggerService.logDebug("Validate_id_token_aud array failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1):e.aud===t||(this.loggerService.logDebug("Validate_id_token_aud failed, dataIdToken.aud: "+e.aud+" client_id:"+t),!1)},e.prototype.validateIdTokenAzpExistsIfMoreThanOneAud=function(e){return!(Array.isArray(e.aud)&&e.aud.length>1&&!(null==e?void 0:e.azp))},e.prototype.validateIdTokenAzpValid=function(e,t){return!(null==e?void 0:e.azp)||e.azp===t},e.prototype.validateStateFromHashCallback=function(e,t){return e===t||(this.loggerService.logDebug("ValidateStateFromHashCallback failed, state: "+e+" local_state:"+t),!1)},e.prototype.validateSignatureIdToken=function(e,t){var r,i,n,s,a,c;if(!t||!t.keys)return!1;var u=this.tokenHelperService.getHeaderFromToken(e,!1);if(0===Object.keys(u).length&&u.constructor===Object)return this.loggerService.logWarning("id token has no header data"),!1;var l=u.kid,h=u.alg;if(!this.keyAlgorithms.includes(h))return this.loggerService.logWarning("alg not supported",h),!1;var g="RSA";"E"===h.charAt(0)&&(g="EC");var p=!1;if(u.hasOwnProperty("kid"))try{for(var f=d(t.keys),v=f.next();!v.done;v=f.next()){if((b=v.value).kid===l){R=o.KEYUTIL.getKey(b);return(p=o.KJUR.jws.JWS.verify(e,R,[h]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),p}}}catch(e){a={error:e}}finally{try{v&&!v.done&&(c=f.return)&&c.call(f)}finally{if(a)throw a.error}}else{var S=0;try{for(var y=d(t.keys),w=y.next();!w.done;w=y.next()){(b=w.value).kty===g&&"sig"===b.use&&(S+=1)}}catch(e){r={error:e}}finally{try{w&&!w.done&&(i=y.return)&&i.call(y)}finally{if(r)throw r.error}}if(0===S)return this.loggerService.logWarning("no keys found, incorrect Signature, validation failed for id_token"),!1;if(S>1)return this.loggerService.logWarning("no ID Token kid claim in JOSE header and multiple supplied in jwks_uri"),!1;try{for(var k=d(t.keys),I=k.next();!I.done;I=k.next()){var b;if((b=I.value).kty===g&&"sig"===b.use){var R=o.KEYUTIL.getKey(b);return(p=o.KJUR.jws.JWS.verify(e,R,[h]))||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),p}}}catch(e){n={error:e}}finally{try{I&&!I.done&&(s=k.return)&&s.call(k)}finally{if(n)throw n.error}}}return p},e.prototype.configValidateResponseType=function(e){return!!this.flowHelper.isCurrentFlowAnyImplicitFlow()||(!!this.flowHelper.isCurrentFlowCodeFlow()||(this.loggerService.logWarning("module configure incorrect, invalid response_type:"+e),!1))},e.prototype.validateIdTokenAtHash=function(e,t,r,i){this.loggerService.logDebug("at_hash from the server:"+t);var n="sha256";i.includes("384")?n="sha384":i.includes("512")&&(n="sha512");var o=this.generateAtHash(""+e,n);if(this.loggerService.logDebug("at_hash client validation not decoded:"+o),o===t)return!0;var s=this.generateAtHash(""+decodeURIComponent(e),n);return this.loggerService.logDebug("-gen access--"+s),s===t},e.prototype.generateAtHash=function(e,t){var r=o.KJUR.crypto.Util.hashString(e,t),i=r.substr(0,r.length/2);return o.hextob64u(i)},e.prototype.generateCodeVerifier=function(e){var t=o.KJUR.crypto.Util.hashString(e,"sha256");return o.hextob64u(t)},e.RefreshTokenNoncePlaceholder="--RefreshToken--",e.ctorParameters=function(){return[{type:P},{type:T},{type:b}]},e=t=l([r.Injectable()],e)}(),D=function(){function t(t,r,i,o,s){this.storagePersistanceService=t,this.loggerService=r,this.publicEventsService=i,this.configurationProvider=o,this.tokenValidationService=s,this.authorizedInternal$=new n.BehaviorSubject(!1),this.authState=e.AuthorizedState.Unknown}return Object.defineProperty(t.prototype,"authorized$",{get:function(){return this.authorizedInternal$.asObservable()},enumerable:!0,configurable:!0}),t.prototype.setAuthorizedAndFireEvent=function(){this.authState=e.AuthorizedState.Authorized,this.persistAuthStateInStorage(this.authState),this.authorizedInternal$.next(!0)},t.prototype.setUnauthorizedAndFireEvent=function(){this.authState=e.AuthorizedState.Unauthorized,this.storagePersistanceService.resetAuthStateInStorage(),this.authorizedInternal$.next(!1)},t.prototype.initStateFromStorage=function(){this.getCurrentlyPersistedAuthState()===e.AuthorizedState.Authorized?this.authState=e.AuthorizedState.Authorized:this.authState=e.AuthorizedState.Unknown},t.prototype.updateAndPublishAuthState=function(t){this.publicEventsService.fireEvent(e.EventTypes.NewAuthorizationResult,t)},t.prototype.setAuthorizationData=function(e,t){this.loggerService.logDebug(e),this.loggerService.logDebug(t),this.loggerService.logDebug("storing to storage, getting the roles"),this.storagePersistanceService.accessToken=e,this.storagePersistanceService.idToken=t,this.setAuthorizedAndFireEvent()},t.prototype.getAccessToken=function(){if(this.authState!==e.AuthorizedState.Authorized)return"";var t=this.storagePersistanceService.getAccessToken();return decodeURIComponent(t)},t.prototype.getIdToken=function(){if(this.authState!==e.AuthorizedState.Authorized)return"";var t=this.storagePersistanceService.getIdToken();return decodeURIComponent(t)},t.prototype.getRefreshToken=function(){if(this.authState!==e.AuthorizedState.Authorized)return"";var t=this.storagePersistanceService.getRefreshToken();return decodeURIComponent(t)},t.prototype.areAuthStorageTokensValid=function(){var t=this.getCurrentlyPersistedAuthState();return t===e.AuthorizedState.Authorized&&(this.loggerService.logDebug("authorizedState in storage is "+t),this.hasIdTokenExpired()?(this.loggerService.logDebug("persisted id_token is expired"),!1):this.hasAccessTokenExpiredIfExpiryExists()?(this.loggerService.logDebug("persisted access_token is expired"),!1):(this.loggerService.logDebug("persisted id_token and access token are valid"),!0))},t.prototype.setAuthResultInStorage=function(e){this.storagePersistanceService.authResult=e},t.prototype.hasIdTokenExpired=function(){var t=this.storagePersistanceService.idToken,r=this.tokenValidationService.hasIdTokenExpired(t,this.configurationProvider.openIDConfiguration.renewTimeBeforeTokenExpiresInSeconds);return r&&this.publicEventsService.fireEvent(e.EventTypes.IdTokenExpired,r),r},t.prototype.hasAccessTokenExpiredIfExpiryExists=function(){var t=this.storagePersistanceService.accessTokenExpiresIn,r=!this.tokenValidationService.validateAccessTokenNotExpired(t,this.configurationProvider.openIDConfiguration.renewTimeBeforeTokenExpiresInSeconds);return r&&this.publicEventsService.fireEvent(e.EventTypes.TokenExpired,r),r},t.prototype.getCurrentlyPersistedAuthState=function(){return this.storagePersistanceService.authorizedState},t.prototype.persistAuthStateInStorage=function(e){this.storagePersistanceService.authorizedState=e},t.ctorParameters=function(){return[{type:C},{type:b},{type:m},{type:I},{type:A}]},t=l([r.Injectable()],t)}(),F=function(){function t(e,t,r,i){this.loggerService=e,this.http=t,this.configurationProvider=r,this.publicEventsService=i,this.WELL_KNOWN_SUFFIX="/.well-known/openid-configuration"}return t.prototype.withConfig=function(t){var r=this;if(t.stsServer)return t.authWellknownEndpoint||(t.authWellknownEndpoint=t.stsServer),this.getWellKnownDocument(t.authWellknownEndpoint).pipe(s.map((function(e){return{issuer:e.issuer,jwksUri:e.jwks_uri,authorizationEndpoint:e.authorization_endpoint,tokenEndpoint:e.token_endpoint,userinfoEndpoint:e.userinfo_endpoint,endSessionEndpoint:e.end_session_endpoint,checkSessionIframe:e.check_session_iframe,revocationEndpoint:e.revocation_endpoint,introspectionEndpoint:e.introspection_endpoint}})),s.tap((function(e){return r.configurationProvider.setConfig(t,e)})),s.tap((function(i){return r.publicEventsService.fireEvent(e.EventTypes.ConfigLoaded,{passedConfig:t,mappedWellKnownEndpoints:i})}))).toPromise();this.loggerService.logError("please provide at least an stsServer")},t.prototype.getWellKnownDocument=function(e){var t=e;return e.includes(this.WELL_KNOWN_SUFFIX)||(t=""+e+this.WELL_KNOWN_SUFFIX),this.http.get(t)},t.ctorParameters=function(){return[{type:b},{type:S},{type:I},{type:m}]},t=l([r.Injectable()],t)}(),z=function(){function e(e){this.loggerService=e}return e.prototype.createRandom=function(e){if(e<=0)return"";e>0&&e<7&&(this.loggerService.logWarning("RandomService called with "+e+" but 7 chars is the minimum, returning 10 chars"),e=10);var t=e-6,r=new Uint8Array((t||t)/2);return this.getCrypto().getRandomValues(r),Array.from(r,this.toHex).join("")+this.randomString(7)},e.prototype.toHex=function(e){return("0"+e.toString(16)).substr(-2)},e.prototype.randomString=function(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=new Uint32Array(e);this.getCrypto().getRandomValues(i);for(var n=0;n<e;n++)t+=r[i[n]%r.length];return t},e.prototype.getCrypto=function(){return window.crypto||window.msCrypto},e.ctorParameters=function(){return[{type:b}]},e=l([r.Injectable()],e)}(),_=function(){function e(e,t){this.storagePersistanceService=e,this.randomService=t}return e.prototype.createNonce=function(){var e=this.randomService.createRandom(40);return this.setNonce(e),e},e.prototype.setNonce=function(e){this.storagePersistanceService.authNonce=e},e.prototype.getAuthStateControl=function(){return this.storagePersistanceService.authStateControl},e.prototype.setAuthStateControl=function(e){this.storagePersistanceService.authStateControl=e},e.prototype.getExistingOrCreateAuthStateControl=function(){var e=this.storagePersistanceService.authStateControl;return e||(e=this.randomService.createRandom(40),this.storagePersistanceService.authStateControl=e),e},e.prototype.setSessionState=function(e){this.storagePersistanceService.sessionState=e},e.prototype.resetStorageFlowData=function(){this.storagePersistanceService.resetStorageFlowData()},e.prototype.getCodeVerifier=function(){return this.storagePersistanceService.codeVerifier},e.prototype.createCodeVerifier=function(){var e=this.randomService.createRandom(67);return this.storagePersistanceService.codeVerifier=e,e},e.prototype.isSilentRenewRunning=function(){return"running"===this.storagePersistanceService.silentRenewRunning},e.prototype.setSilentRenewRunning=function(){this.storagePersistanceService.silentRenewRunning="running"},e.prototype.resetSilentRenewRunning=function(){this.storagePersistanceService.silentRenewRunning=""},e.ctorParameters=function(){return[{type:C},{type:z}]},e=l([r.Injectable()],e)}(),U=function(){function t(e,t,r,i,o,s,a){this.oidcDataService=e,this.storagePersistanceService=t,this.eventService=r,this.loggerService=i,this.tokenHelperService=o,this.configurationProvider=s,this.flowHelper=a,this.userDataInternal$=new n.BehaviorSubject(null)}return Object.defineProperty(t.prototype,"userData$",{get:function(){return this.userDataInternal$.asObservable()},enumerable:!0,configurable:!0}),t.prototype.getAndPersistUserDataInStore=function(e,t,r){var i=this;void 0===e&&(e=!1),t=t||this.storagePersistanceService.idToken,r=r||this.tokenHelperService.getPayloadFromToken(t,!1);var o=this.getUserDataFromStore(),a=!!o,c=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(),u=this.flowHelper.isCurrentFlowCodeFlow();return c||u?!a&&e||!e?this.getUserDataOidcFlowAndSave(r.sub).pipe(s.switchMap((function(e){return i.loggerService.logDebug("Received user data",e),e?(i.loggerService.logDebug(i.storagePersistanceService.accessToken),n.of(e)):n.throwError("no user data, request failed")}))):n.of(o):(this.loggerService.logDebug("authorizedCallback id_token flow"),this.loggerService.logDebug(this.storagePersistanceService.accessToken),this.setUserDataToStore(r),n.of(r))},t.prototype.getUserDataFromStore=function(){return this.storagePersistanceService.userData||null},t.prototype.publishUserdataIfExists=function(){var t=this.getUserDataFromStore();t&&(this.userDataInternal$.next(t),this.eventService.fireEvent(e.EventTypes.UserDataChanged,t))},t.prototype.setUserDataToStore=function(t){this.storagePersistanceService.userData=t,this.userDataInternal$.next(t),this.eventService.fireEvent(e.EventTypes.UserDataChanged,t)},t.prototype.resetUserDataInStore=function(){this.storagePersistanceService.userData=null,this.eventService.fireEvent(e.EventTypes.UserDataChanged,null),this.userDataInternal$.next(null)},t.prototype.getUserDataOidcFlowAndSave=function(e){var t=this;return this.getIdentityUserData().pipe(s.map((function(r){return t.validateUserdataSubIdToken(e,null==r?void 0:r.sub)?(t.setUserDataToStore(r),r):(t.loggerService.logWarning("authorizedCallback, User data sub does not match sub in id_token"),t.loggerService.logDebug("authorizedCallback, token(s) validation failed, resetting"),t.resetUserDataInStore(),null)})))},t.prototype.getIdentityUserData=function(){var e,t,r=this.storagePersistanceService.getAccessToken();return this.configurationProvider.wellKnownEndpoints?(null===(t=null===(e=this.configurationProvider)||void 0===e?void 0:e.wellKnownEndpoints)||void 0===t?void 0:t.userinfoEndpoint)?this.oidcDataService.get(this.configurationProvider.wellKnownEndpoints.userinfoEndpoint,r):(this.loggerService.logError("init check session: authWellKnownEndpoints.userinfo_endpoint is undefined; set auto_userinfo = false in config"),n.throwError("authWellKnownEndpoints.userinfo_endpoint is undefined")):(this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined"),n.throwError("authWellKnownEndpoints is undefined"))},t.prototype.validateUserdataSubIdToken=function(e,t){return!!e&&(!!t&&(e===t||(this.loggerService.logDebug("validateUserdataSubIdToken failed",e,t),!1)))},t.ctorParameters=function(){return[{type:S},{type:C},{type:m},{type:b},{type:P},{type:I},{type:T}]},t=l([r.Injectable()],t)}();function O(){return window}var V,x,j,W,H,K=new r.InjectionToken("WindowToken"),N=function(){function e(){}return e.prototype.encodeKey=function(e){return encodeURIComponent(e)},e.prototype.encodeValue=function(e){return encodeURIComponent(e)},e.prototype.decodeKey=function(e){return decodeURIComponent(e)},e.prototype.decodeValue=function(e){return decodeURIComponent(e)},e}(),L=function(){function e(e,t,r,i,n,o){this.configurationProvider=e,this.loggerService=t,this.flowsDataService=r,this.flowHelper=i,this.tokenValidationService=n,this.window=o,this.CALLBACK_PARAMS_TO_CHECK=["code","state","token","id_token"]}return e.prototype.getUrlParameter=function(e,t){if(!e)return"";if(!t)return"";t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e);return null===r?"":decodeURIComponent(r[1])},e.prototype.isCallbackFromSts=function(){var e=this;return this.CALLBACK_PARAMS_TO_CHECK.some((function(t){return!!e.getUrlParameter(e.window.location.toString(),t)}))},e.prototype.getRefreshSessionSilentRenewUrl=function(){return this.flowHelper.isCurrentFlowCodeFlow()?this.createUrlCodeFlowWithSilentRenew():this.createUrlImplicitFlowWithSilentRenew()||""},e.prototype.getAuthorizeUrl=function(e){return this.flowHelper.isCurrentFlowCodeFlow()?this.createUrlCodeFlowAuthorize(e):this.createUrlImplicitFlowAuthorize(e)||""},e.prototype.createEndSessionUrl=function(e){var t,r=null===(t=this.configurationProvider.wellKnownEndpoints)||void 0===t?void 0:t.endSessionEndpoint;if(!r)return null;var n=r.split("?"),o=n[0],s=new i.HttpParams({fromString:n[1],encoder:new N});s=s.set("id_token_hint",e);var a=this.getPostLogoutRedirectUrl();return a&&(s=s.append("post_logout_redirect_uri",a)),o+"?"+s},e.prototype.createRevocationEndpointBodyAccessToken=function(e){var t=this.getClientId();return t?"client_id="+t+"&token="+e+"&token_type_hint=access_token":null},e.prototype.createRevocationEndpointBodyRefreshToken=function(e){var t=this.getClientId();return t?"client_id="+t+"&token="+e+"&token_type_hint=refresh_token":null},e.prototype.getRevocationEndpointUrl=function(){var e,t=null===(e=this.configurationProvider.wellKnownEndpoints)||void 0===e?void 0:e.revocationEndpoint;return t?t.split("?")[0]:null},e.prototype.createBodyForCodeFlowCodeRequest=function(e){var t=this.flowsDataService.getCodeVerifier();if(!t)return this.loggerService.logError("CodeVerifier is not set ",t),null;var r=this.getClientId();if(!r)return null;var i=a.oneLineTrim(V||(V=p(["grant_type=authorization_code\n            &client_id=","\n            &code_verifier=","\n            &code=",""],["grant_type=authorization_code\n            &client_id=","\n            &code_verifier=","\n            &code=",""])),r,t,e),n=this.getSilentRenewUrl();if(this.flowsDataService.isSilentRenewRunning()&&n)return a.oneLineTrim(x||(x=p(["","&redirect_uri=",""],["","&redirect_uri=",""])),i,n);var o=this.getRedirectUrl();return o?a.oneLineTrim(j||(j=p(["","&redirect_uri=",""],["","&redirect_uri=",""])),i,o):null},e.prototype.createBodyForCodeFlowRefreshTokensRequest=function(e){var t=this.getClientId();return t?a.oneLineTrim(W||(W=p(["grant_type=refresh_token\n          &client_id=","\n          &refresh_token=",""],["grant_type=refresh_token\n          &client_id=","\n          &refresh_token=",""])),t,e):null},e.prototype.createAuthorizeUrl=function(e,t,r,n,o,s){var a,c,l,h,p=null===(h=null===(l=this.configurationProvider)||void 0===l?void 0:l.wellKnownEndpoints)||void 0===h?void 0:h.authorizationEndpoint;if(!p)return this.loggerService.logError("Can not create an authorize url when authorizationEndpoint is '"+p+"'"),null;var f=this.configurationProvider.openIDConfiguration,v=f.clientId,S=f.responseType,y=f.scope,w=f.hdParam,k=f.customParams;if(!v)return this.loggerService.logError("createAuthorizeUrl could not add clientId because it was: ",v),null;if(!S)return this.loggerService.logError("createAuthorizeUrl could not add responseType because it was: ",S),null;if(!y)return this.loggerService.logError("createAuthorizeUrl could not add scope because it was: ",y),null;var I=p.split("?"),b=I[0],R=new i.HttpParams({fromString:I[1],encoder:new N});if(R=(R=(R=(R=(R=(R=R.set("client_id",v)).append("redirect_uri",t)).append("response_type",S)).append("scope",y)).append("nonce",r)).append("state",n),this.flowHelper.isCurrentFlowCodeFlow()&&(R=(R=R.append("code_challenge",e)).append("code_challenge_method","S256")),o&&(R=R.append("prompt",o)),w&&(R=R.append("hd",w)),k||s){var m=u(u({},k||{}),s||{});try{for(var E=d(Object.entries(m)),C=E.next();!C.done;C=E.next()){var T=g(C.value,2),P=T[0],A=T[1];R=R.append(P,A.toString())}}catch(e){a={error:e}}finally{try{C&&!C.done&&(c=E.return)&&c.call(E)}finally{if(a)throw a.error}}}return b+"?"+R},e.prototype.createUrlImplicitFlowWithSilentRenew=function(){var e=this.flowsDataService.getExistingOrCreateAuthStateControl(),t=this.flowsDataService.createNonce(),r=this.getSilentRenewUrl();return r?(this.loggerService.logDebug("RefreshSession created. adding myautostate: ",e),this.configurationProvider.wellKnownEndpoints?this.createAuthorizeUrl("",r,t,e,"none"):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null)):null},e.prototype.createUrlCodeFlowWithSilentRenew=function(){var e=this.flowsDataService.getExistingOrCreateAuthStateControl(),t=this.flowsDataService.createNonce();this.loggerService.logDebug("RefreshSession created. adding myautostate: "+e);var r=this.flowsDataService.createCodeVerifier(),i=this.tokenValidationService.generateCodeVerifier(r),n=this.getSilentRenewUrl();return n?this.configurationProvider.wellKnownEndpoints?this.createAuthorizeUrl(i,n,t,e,"none"):(this.loggerService.logWarning("authWellKnownEndpoints is undefined"),null):null},e.prototype.createUrlImplicitFlowAuthorize=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("Authorize created. adding myautostate: "+t);var i=this.getRedirectUrl();return i?this.configurationProvider.wellKnownEndpoints?this.createAuthorizeUrl("",i,r,t,null,e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null):null},e.prototype.createUrlCodeFlowAuthorize=function(e){var t=this.flowsDataService.getExistingOrCreateAuthStateControl(),r=this.flowsDataService.createNonce();this.loggerService.logDebug("Authorize created. adding myautostate: "+t);var i=this.getRedirectUrl();if(!i)return null;var n=this.flowsDataService.createCodeVerifier(),o=this.tokenValidationService.generateCodeVerifier(n);return this.configurationProvider.wellKnownEndpoints?this.createAuthorizeUrl(o,i,r,t,null,e):(this.loggerService.logError("authWellKnownEndpoints is undefined"),null)},e.prototype.getRedirectUrl=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.redirectUrl;return t||(this.loggerService.logError("could not get redirectUrl, was: ",t),null)},e.prototype.getSilentRenewUrl=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.silentRenewUrl;return t||(this.loggerService.logError("could not get silentRenewUrl, was: ",t),null)},e.prototype.getPostLogoutRedirectUrl=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.postLogoutRedirectUri;return t||(this.loggerService.logError("could not get postLogoutRedirectUri, was: ",t),null)},e.prototype.getClientId=function(){var e,t=null===(e=this.configurationProvider.openIDConfiguration)||void 0===e?void 0:e.clientId;return t||(this.loggerService.logError("could not get clientId, was: ",t),null)},e.ctorParameters=function(){return[{type:I},{type:b},{type:_},{type:T},{type:A},{type:void 0,decorators:[{type:r.Inject,args:[K]}]}]},e=l([r.Injectable(),h(5,r.Inject(K))],e)}();(H=e.ValidationResult||(e.ValidationResult={})).NotSet="NotSet",H.StatesDoNotMatch="StatesDoNotMatch",H.SignatureFailed="SignatureFailed",H.IncorrectNonce="IncorrectNonce",H.RequiredPropertyMissing="RequiredPropertyMissing",H.MaxOffsetExpired="MaxOffsetExpired",H.IssDoesNotMatchIssuer="IssDoesNotMatchIssuer",H.NoAuthWellKnownEndPoints="NoAuthWellKnownEndPoints",H.IncorrectAud="IncorrectAud",H.IncorrectIdTokenClaimsAfterRefresh="IncorrectIdTokenClaimsAfterRefresh",H.IncorrectAzp="IncorrectAzp",H.TokenExpired="TokenExpired",H.IncorrectAtHash="IncorrectAtHash",H.Ok="Ok",H.LoginRequired="LoginRequired",H.SecureTokenServerError="SecureTokenServerError";var M=function(t,r,i,n,o){void 0===t&&(t=""),void 0===r&&(r=""),void 0===i&&(i=!1),void 0===n&&(n={}),void 0===o&&(o=e.ValidationResult.NotSet),this.accessToken=t,this.idToken=r,this.authResponseIsValid=i,this.decodedIdToken=n,this.state=o},q=function(){function t(e,t,r,i,n,o){this.storagePersistanceService=e,this.tokenValidationService=t,this.tokenHelperService=r,this.loggerService=i,this.configurationProvider=n,this.flowHelper=o}return t.prototype.getValidatedStateResult=function(e){return(null==e?void 0:e.authResult.error)?new M("","",!1,{}):this.validateState(e)},t.prototype.isIdTokenAfterRefreshTokenRequestValid=function(e,t){if(!this.configurationProvider.openIDConfiguration.useRefreshToken)return!0;if(!e.existingIdToken)return!0;var r=this.tokenHelperService.getPayloadFromToken(e.existingIdToken,!1);return r.iss!==t.iss?(this.loggerService.logDebug("iss do not match: "+r.iss+" "+t.iss),!1):r.azp!==t.azp?(this.loggerService.logDebug("azp do not match: "+r.azp+" "+t.azp),!1):r.sub!==t.sub?(this.loggerService.logDebug("sub do not match: "+r.sub+" "+t.sub),!1):r.aud!==t.aud?(this.loggerService.logDebug("aud do not match: "+r.aud+" "+t.aud),!1):!!this.configurationProvider.openIDConfiguration.disableRefreshIdTokenAuthTimeValidation||(r.auth_time===t.auth_time||(this.loggerService.logDebug("auth_time do not match: "+r.auth_time+" "+t.auth_time),!1))},t.prototype.validateState=function(t){var r=new M;if(!this.tokenValidationService.validateStateFromHashCallback(t.authResult.state,this.storagePersistanceService.authStateControl))return this.loggerService.logWarning("authorizedCallback incorrect state"),r.state=e.ValidationResult.StatesDoNotMatch,this.handleUnsuccessfulValidation(),r;var i=this.flowHelper.isCurrentFlowImplicitFlowWithAccessToken(),n=this.flowHelper.isCurrentFlowCodeFlow();if((i||n)&&(r.accessToken=t.authResult.access_token),t.authResult.id_token){if(r.idToken=t.authResult.id_token,r.decodedIdToken=this.tokenHelperService.getPayloadFromToken(r.idToken,!1),!this.tokenValidationService.validateSignatureIdToken(r.idToken,t.jwtKeys))return this.loggerService.logDebug("authorizedCallback Signature validation failed id_token"),r.state=e.ValidationResult.SignatureFailed,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenNonce(r.decodedIdToken,this.storagePersistanceService.authNonce,this.configurationProvider.openIDConfiguration.ignoreNonceAfterRefresh))return this.loggerService.logWarning("authorizedCallback incorrect nonce"),r.state=e.ValidationResult.IncorrectNonce,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateRequiredIdToken(r.decodedIdToken))return this.loggerService.logDebug("authorizedCallback Validation, one of the REQUIRED properties missing from id_token"),r.state=e.ValidationResult.RequiredPropertyMissing,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenIatMaxOffset(r.decodedIdToken,this.configurationProvider.openIDConfiguration.maxIdTokenIatOffsetAllowedInSeconds,this.configurationProvider.openIDConfiguration.disableIatOffsetValidation))return this.loggerService.logWarning("authorizedCallback Validation, iat rejected id_token was issued too far away from the current time"),r.state=e.ValidationResult.MaxOffsetExpired,this.handleUnsuccessfulValidation(),r;if(!this.configurationProvider.wellKnownEndpoints)return this.loggerService.logWarning("authWellKnownEndpoints is undefined"),r.state=e.ValidationResult.NoAuthWellKnownEndPoints,this.handleUnsuccessfulValidation(),r;if(this.configurationProvider.openIDConfiguration.issValidationOff)this.loggerService.logDebug("iss validation is turned off, this is not recommended!");else if(!this.configurationProvider.openIDConfiguration.issValidationOff&&!this.tokenValidationService.validateIdTokenIss(r.decodedIdToken,this.configurationProvider.wellKnownEndpoints.issuer))return this.loggerService.logWarning("authorizedCallback incorrect iss does not match authWellKnownEndpoints issuer"),r.state=e.ValidationResult.IssDoesNotMatchIssuer,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAud(r.decodedIdToken,this.configurationProvider.openIDConfiguration.clientId))return this.loggerService.logWarning("authorizedCallback incorrect aud"),r.state=e.ValidationResult.IncorrectAud,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAzpExistsIfMoreThanOneAud(r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback missing azp"),r.state=e.ValidationResult.IncorrectAzp,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenAzpValid(r.decodedIdToken,this.configurationProvider.openIDConfiguration.clientId))return this.loggerService.logWarning("authorizedCallback incorrect azp"),r.state=e.ValidationResult.IncorrectAzp,this.handleUnsuccessfulValidation(),r;if(!this.isIdTokenAfterRefreshTokenRequestValid(t,r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback pre, post id_token claims do not match in refresh"),r.state=e.ValidationResult.IncorrectIdTokenClaimsAfterRefresh,this.handleUnsuccessfulValidation(),r;if(!this.tokenValidationService.validateIdTokenExpNotExpired(r.decodedIdToken))return this.loggerService.logWarning("authorizedCallback id token expired"),r.state=e.ValidationResult.TokenExpired,this.handleUnsuccessfulValidation(),r}else this.loggerService.logDebug("No id_token found, skipping id_token validation");if(!i&&!n)return r.authResponseIsValid=!0,r.state=e.ValidationResult.Ok,this.handleSuccessfulValidation(),this.handleUnsuccessfulValidation(),r;var o=this.tokenHelperService.getHeaderFromToken(r.idToken,!1);if(n&&!r.decodedIdToken.at_hash)this.loggerService.logDebug("Code Flow active, and no at_hash in the id_token, skipping check!");else if(!this.tokenValidationService.validateIdTokenAtHash(r.accessToken,r.decodedIdToken.at_hash,n,o.alg)||!r.accessToken)return this.loggerService.logWarning("authorizedCallback incorrect at_hash"),r.state=e.ValidationResult.IncorrectAtHash,this.handleUnsuccessfulValidation(),r;return r.authResponseIsValid=!0,r.state=e.ValidationResult.Ok,this.handleSuccessfulValidation(),r},t.prototype.handleSuccessfulValidation=function(){this.storagePersistanceService.authNonce="",this.configurationProvider.openIDConfiguration.autoCleanStateAfterAuthentication&&(this.storagePersistanceService.authStateControl=""),this.loggerService.logDebug("AuthorizedCallback token(s) validated, continue")},t.prototype.handleUnsuccessfulValidation=function(){this.storagePersistanceService.authNonce="",this.configurationProvider.openIDConfiguration.autoCleanStateAfterAuthentication&&(this.storagePersistanceService.authStateControl=""),this.loggerService.logDebug("AuthorizedCallback token(s) invalid")},t.ctorParameters=function(){return[{type:C},{type:A},{type:P},{type:b},{type:I},{type:T}]},t=l([r.Injectable()],t)}(),B=function(){function e(e,t,r){this.configurationProvider=e,this.loggerService=t,this.dataService=r}return e.prototype.getSigningKeys=function(){var e,t;if(!(null===(e=this.configurationProvider.wellKnownEndpoints)||void 0===e?void 0:e.jwksUri)){var r="getSigningKeys: authWellKnownEndpoints.jwksUri is: '"+(null===(t=this.configurationProvider.wellKnownEndpoints)||void 0===t?void 0:t.jwksUri)+"'";return this.loggerService.logWarning(r),n.throwError(r)}return this.loggerService.logDebug("Getting signinkeys from ",this.configurationProvider.wellKnownEndpoints.jwksUri),this.dataService.get(this.configurationProvider.wellKnownEndpoints.jwksUri).pipe(s.catchError(this.handleErrorGetSigningKeys))},e.prototype.handleErrorGetSigningKeys=function(e){var t;if(e instanceof Response){var r=e.json()||{},i=JSON.stringify(r);t=e.status+" - "+(e.statusText||"")+" "+i}else t=e.message?e.message:e.toString();return this.loggerService.logError(t),n.throwError(t)},e.ctorParameters=function(){return[{type:I},{type:b},{type:S}]},e=l([r.Injectable()],e)}(),$=function(){function t(e,t,r,i,n,o,s,a,c,u){this.urlService=e,this.loggerService=t,this.tokenValidationService=r,this.configurationProvider=i,this.authStateService=n,this.flowsDataService=o,this.signinKeyDataService=s,this.dataService=a,this.userService=c,this.stateValidationService=u}return t.prototype.resetAuthorizationData=function(){this.configurationProvider.openIDConfiguration.autoUserinfo&&this.userService.resetUserDataInStore(),this.flowsDataService.resetStorageFlowData(),this.authStateService.setUnauthorizedAndFireEvent()},t.prototype.processCodeFlowCallback=function(e){var t=this;return this.codeFlowCallback(e).pipe(s.switchMap((function(e){return t.codeFlowCodeRequest(e)})),s.switchMap((function(e){return t.codeFlowSilentRenewCheck(e)})),s.switchMap((function(e){return t.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.callbackStateValidation(e)})),s.switchMap((function(e){return t.callbackUser(e)})))},t.prototype.processSilentRenewCodeFlowCallback=function(e){var t=this;return this.codeFlowCodeRequest(e).pipe(s.switchMap((function(e){return t.codeFlowSilentRenewCheck(e)})),s.switchMap((function(e){return t.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.callbackStateValidation(e)})),s.switchMap((function(e){return t.callbackUser(e)})))},t.prototype.processImplicitFlowCallback=function(e){var t=this;return this.implicitFlowCallback(e).pipe(s.switchMap((function(e){return t.callbackHistoryAndResetJwtKeys(e)})),s.switchMap((function(e){return t.callbackStateValidation(e)})),s.switchMap((function(e){return t.callbackUser(e)})))},t.prototype.processRefreshToken=function(){var e=this;return this.refreshSessionWithRefreshTokens().pipe(s.switchMap((function(t){return e.refreshTokensRequestTokens(t)})),s.switchMap((function(t){return e.codeFlowSilentRenewCheck(t)})),s.switchMap((function(t){return e.callbackHistoryAndResetJwtKeys(t)})),s.switchMap((function(t){return e.callbackStateValidation(t)})),s.switchMap((function(t){return e.callbackUser(t)})))},t.prototype.codeFlowCallback=function(e){var t=this.urlService.getUrlParameter(e,"code"),r=this.urlService.getUrlParameter(e,"state"),i=this.urlService.getUrlParameter(e,"session_state")||null;if(!r)return this.loggerService.logDebug("no state in url"),n.throwError("no state in url");if(!t)return this.loggerService.logDebug("no code in url"),n.throwError("no code in url");this.loggerService.logDebug("running validation for callback"+e);var o={code:t,refreshToken:null,state:r,sessionState:i,authResult:null,isRenewProcess:!1,jwtKeys:null,validationResult:null,existingIdToken:null};return n.of(o)},t.prototype.implicitFlowCallback=function(e){var t=this.flowsDataService.isSilentRenewRunning();this.loggerService.logDebug("BEGIN authorizedCallback, no auth data"),t||this.resetAuthorizationData();var r={code:null,refreshToken:null,state:null,sessionState:null,authResult:(e=e||window.location.hash.substr(1)).split("&").reduce((function(e,t){var r=t.split("=");return e[r.shift()]=r.join("="),e}),{}),isRenewProcess:t,jwtKeys:null,validationResult:null,existingIdToken:null};return n.of(r)},t.prototype.refreshSessionWithRefreshTokens=function(){var e=this.flowsDataService.getExistingOrCreateAuthStateControl();this.loggerService.logDebug("RefreshSession created. adding myautostate: "+e);var t=this.authStateService.getRefreshToken(),r=this.authStateService.getIdToken();if(t){var i={code:null,refreshToken:t,state:e,sessionState:null,authResult:null,isRenewProcess:!1,jwtKeys:null,validationResult:null,existingIdToken:r};return this.loggerService.logDebug("found refresh code, obtaining new credentials with refresh code"),this.flowsDataService.setNonce(A.RefreshTokenNoncePlaceholder),n.of(i)}return this.loggerService.logError("no refresh token found, please login"),n.throwError("no refresh token found, please login")},t.prototype.refreshTokensRequestTokens=function(e){var t=this,r=new i.HttpHeaders;r=r.set("Content-Type","application/x-www-form-urlencoded");var o=this.getTokenEndpoint();if(!o)return n.throwError("Token Endpoint not defined");var a=this.urlService.createBodyForCodeFlowRefreshTokensRequest(e.refreshToken);return this.dataService.post(o,a,r).pipe(s.switchMap((function(r){t.loggerService.logDebug("token refresh response: ",r);var i=new Object;return(i=r).state=e.state,e.authResult=i,n.of(e)})),s.catchError((function(e){var r="OidcService code request "+t.configurationProvider.openIDConfiguration.stsServer+": "+e;return t.loggerService.logError(r),n.throwError(r)})))},t.prototype.codeFlowCodeRequest=function(e){var t=this;if(!this.tokenValidationService.validateStateFromHashCallback(e.state,this.flowsDataService.getAuthStateControl()))return this.loggerService.logWarning("codeFlowCodeRequest incorrect state"),n.throwError("codeFlowCodeRequest incorrect state");var r=this.getTokenEndpoint();if(!r)return n.throwError("Token Endpoint not defined");var o=new i.HttpHeaders;o=o.set("Content-Type","application/x-www-form-urlencoded");var a=this.urlService.createBodyForCodeFlowCodeRequest(e.code);return this.dataService.post(r,a,o).pipe(s.switchMap((function(t){var r=new Object;return(r=t).state=e.state,r.session_state=e.sessionState,e.authResult=r,n.of(e)})),s.catchError((function(e){var r="OidcService code request "+t.configurationProvider.openIDConfiguration.stsServer+" with error "+e;return t.loggerService.logError(r),n.throwError(r)})))},t.prototype.codeFlowSilentRenewCheck=function(e){return e.isRenewProcess=this.flowsDataService.isSilentRenewRunning(),this.loggerService.logDebug("BEGIN authorized Code Flow Callback, no auth data"),e.isRenewProcess||this.resetAuthorizationData(),n.of(e)},t.prototype.callbackHistoryAndResetJwtKeys=function(e){var t=this;if(this.authStateService.setAuthResultInStorage(e.authResult),this.historyCleanUpTurnedOn()&&!e.isRenewProcess?this.resetBrowserHistory():this.loggerService.logDebug("history clean up inactive"),e.authResult.error){var r="authorizedCallbackProcedure came with error: "+e.authResult.error;return this.loggerService.logDebug(r),this.resetAuthorizationData(),this.flowsDataService.setNonce(""),this.handleResultErrorFromCallback(e.authResult,e.isRenewProcess),n.throwError(r)}return this.loggerService.logDebug(e.authResult),this.loggerService.logDebug("authorizedCallback created, begin token validation"),this.signinKeyDataService.getSigningKeys().pipe(s.switchMap((function(r){if(r)return e.jwtKeys=r,n.of(e);return t.loggerService.logWarning("Failed to retrieve signing key"),n.throwError("Failed to retrieve signing key")})),s.catchError((function(e){var r="Failed to retrieve signing key with error: "+e;return t.loggerService.logWarning(r),n.throwError(r)})))},t.prototype.callbackStateValidation=function(e){var t=this.stateValidationService.getValidatedStateResult(e);if(e.validationResult=t,t.authResponseIsValid)return this.authStateService.setAuthorizationData(t.accessToken,t.idToken),n.of(e);var r="authorizedCallback, token(s) validation failed, resetting. Hash: "+window.location.hash;return this.loggerService.logWarning(r),this.resetAuthorizationData(),this.publishUnauthorizedState(e.validationResult,e.isRenewProcess),n.throwError(r)},t.prototype.callbackUser=function(e){var t=this;return this.configurationProvider.openIDConfiguration.autoUserinfo?this.userService.getAndPersistUserDataInStore(e.isRenewProcess,e.validationResult.idToken,e.validationResult.decodedIdToken).pipe(s.switchMap((function(r){if(r)return t.flowsDataService.setSessionState(e.authResult.session_state),t.publishAuthorizedState(e.validationResult,e.isRenewProcess),n.of(e);t.resetAuthorizationData(),t.publishUnauthorizedState(e.validationResult,e.isRenewProcess);var i="Called for userData but they were "+r;return t.loggerService.logWarning(i),n.throwError(i)})),s.catchError((function(e){var r="Failed to retreive user info with error:  "+e;return t.loggerService.logWarning(r),n.throwError(r)}))):(e.isRenewProcess||this.userService.setUserDataToStore(e.validationResult.decodedIdToken),this.publishAuthorizedState(e.validationResult,e.isRenewProcess),n.of(e))},t.prototype.publishAuthorizedState=function(t,r){this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Authorized,validationResult:t.state,isRenewProcess:r})},t.prototype.publishUnauthorizedState=function(t,r){this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:t.state,isRenewProcess:r})},t.prototype.handleResultErrorFromCallback=function(t,r){var i=e.ValidationResult.SecureTokenServerError;"login_required"===t.error&&(i=e.ValidationResult.LoginRequired),this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:i,isRenewProcess:r})},t.prototype.getTokenEndpoint=function(){var e;return(null===(e=this.configurationProvider.wellKnownEndpoints)||void 0===e?void 0:e.tokenEndpoint)||null},t.prototype.historyCleanUpTurnedOn=function(){return!this.configurationProvider.openIDConfiguration.historyCleanupOff},t.prototype.resetBrowserHistory=function(){window.history.replaceState({},window.document.title,window.location.origin+window.location.pathname)},t.ctorParameters=function(){return[{type:L},{type:b},{type:A},{type:I},{type:D},{type:_},{type:B},{type:S},{type:U},{type:q}]},t=l([r.Injectable()],t)}(),J=function(){function e(e){this.loggerService=e}return e.prototype.getExistingIFrame=function(e){var t=this.getIFrameFromParentWindow(e);if(this.isIFrameElement(t))return t;var r=this.getIFrameFromWindow(e);return this.isIFrameElement(r)?r:null},e.prototype.addIFrameToWindowBody=function(e){var t=window.document.createElement("iframe");return t.id=e,this.loggerService.logDebug(t),t.style.display="none",window.document.body.appendChild(t),t},e.prototype.getIFrameFromParentWindow=function(e){try{var t=window.parent.document.getElementById(e);return this.isIFrameElement(t)?t:null}catch(e){return null}},e.prototype.getIFrameFromWindow=function(e){var t=window.document.getElementById(e);return this.isIFrameElement(t)?t:null},e.prototype.isIFrameElement=function(e){return!!e&&e instanceof HTMLIFrameElement},e.ctorParameters=function(){return[{type:b}]},e=l([r.Injectable()],e)}(),G=function(){function t(e,t,r,i,o,s){this.storagePersistanceService=e,this.loggerService=t,this.iFrameService=r,this.zone=i,this.eventService=o,this.configurationProvider=s,this.checkSessionReceived=!1,this.lastIFrameRefresh=0,this.outstandingMessages=0,this.heartBeatInterval=3e3,this.iframeRefreshInterval=6e4,this.checkSessionChangedInternal$=new n.BehaviorSubject(!1)}return Object.defineProperty(t.prototype,"checkSessionChanged$",{get:function(){return this.checkSessionChangedInternal$.asObservable()},enumerable:!0,configurable:!0}),t.prototype.isCheckSessionConfigured=function(){return this.configurationProvider.openIDConfiguration.startCheckSession},t.prototype.start=function(){if(!this.scheduledHeartBeatRunning){this.init();var e=this.configurationProvider.openIDConfiguration.clientId;this.pollServerSession(e)}},t.prototype.stop=function(){this.scheduledHeartBeatRunning&&(this.clearScheduledHeartBeat(),this.checkSessionReceived=!1)},t.prototype.serverStateChanged=function(){return this.configurationProvider.openIDConfiguration.startCheckSession&&this.checkSessionReceived},t.prototype.init=function(){var e=this;if(!(this.lastIFrameRefresh+this.iframeRefreshInterval>Date.now()))if(this.configurationProvider.wellKnownEndpoints){var t=this.getOrCreateIframe();this.configurationProvider.wellKnownEndpoints.checkSessionIframe?t.contentWindow.location.replace(this.configurationProvider.wellKnownEndpoints.checkSessionIframe):this.loggerService.logWarning("init check session: checkSessionIframe is not configured to run"),this.bindMessageEventToIframe(),t.onload=function(){e.lastIFrameRefresh=Date.now()}}else this.loggerService.logWarning("init check session: authWellKnownEndpoints is undefined. Returning.")},t.prototype.pollServerSession=function(e){var t=this;this.outstandingMessages=0;var r=function(){var r=t.getExistingIframe();if(r&&e){t.loggerService.logDebug(r);var i=t.storagePersistanceService.sessionState;i?(t.outstandingMessages++,r.contentWindow.postMessage(e+" "+i,t.configurationProvider.openIDConfiguration.stsServer)):t.loggerService.logDebug("OidcSecurityCheckSession pollServerSession session_state is blank")}else t.loggerService.logWarning("OidcSecurityCheckSession pollServerSession checkSession IFrame does not exist"),t.loggerService.logDebug(e),t.loggerService.logDebug(r);t.outstandingMessages>3&&t.loggerService.logError("OidcSecurityCheckSession not receiving check session response messages. Outstanding messages: "+t.outstandingMessages+". Server unreachable?")};this.zone.runOutsideAngular((function(){t.scheduledHeartBeatRunning=setInterval(r,t.heartBeatInterval)}))},t.prototype.clearScheduledHeartBeat=function(){clearTimeout(this.scheduledHeartBeatRunning),this.scheduledHeartBeatRunning=null},t.prototype.messageHandler=function(t){var r=this.getExistingIframe();this.outstandingMessages=0,r&&this.configurationProvider.openIDConfiguration.stsServer.startsWith(t.origin)&&t.source===r.contentWindow&&("error"===t.data?this.loggerService.logWarning("error from checksession messageHandler"):"changed"===t.data?(this.loggerService.logDebug(t),this.checkSessionReceived=!0,this.eventService.fireEvent(e.EventTypes.CheckSessionReceived,t.data),this.checkSessionChangedInternal$.next(!0)):(this.eventService.fireEvent(e.EventTypes.CheckSessionReceived,t.data),this.loggerService.logDebug(t.data+" from checksession messageHandler")))},t.prototype.getExistingIframe=function(){return this.iFrameService.getExistingIFrame("myiFrameForCheckSession")},t.prototype.bindMessageEventToIframe=function(){var e=this.messageHandler.bind(this);window.addEventListener("message",e,!1)},t.prototype.getOrCreateIframe=function(){var e=this.getExistingIframe();return e||this.iFrameService.addIFrameToWindowBody("myiFrameForCheckSession")},t.ctorParameters=function(){return[{type:C},{type:b},{type:J},{type:r.NgZone},{type:m},{type:I}]},t=l([r.Injectable()],t)}(),X=function(){function e(e,t){this.configurationProvider=e,this.iFrameService=t}return e.prototype.getOrCreateIframe=function(){var e=this.getExistingIframe();return e||this.iFrameService.addIFrameToWindowBody("myiFrameForSilentRenew")},e.prototype.isSilentRenewConfigured=function(){return!this.configurationProvider.openIDConfiguration.useRefreshToken&&this.configurationProvider.openIDConfiguration.silentRenew},e.prototype.getExistingIframe=function(){return this.iFrameService.getExistingIFrame("myiFrameForSilentRenew")},e.ctorParameters=function(){return[{type:I},{type:J}]},e=l([r.Injectable()],e)}(),Y=function(){function e(e){this.window=e}return e.prototype.redirectTo=function(e){this.window.location.href=e},e.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[K]}]}]},e.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new e(r.ɵɵinject(K))},token:e,providedIn:"root"}),e=l([r.Injectable({providedIn:"root"}),h(0,r.Inject(K))],e)}(),Q=function(){function e(e,t,r,i,n,o,s,a){this.dataService=e,this.storagePersistanceService=t,this.loggerService=r,this.urlService=i,this.checkSessionService=n,this.flowsService=o,this.redirectService=s,this.configurationProvider=a}return e.prototype.logoff=function(e){this.loggerService.logDebug("logoff, remove auth ");var t=this.getEndSessionUrl();this.flowsService.resetAuthorizationData(),t?this.checkSessionService.serverStateChanged()?this.loggerService.logDebug("only local login cleaned up, server session has changed"):e?e(t):this.redirectService.redirectTo(t):this.loggerService.logDebug("only local login cleaned up, no end_session_endpoint")},e.prototype.logoffLocal=function(){this.flowsService.resetAuthorizationData()},e.prototype.logoffAndRevokeTokens=function(e){var t,r=this;return(null===(t=this.configurationProvider.wellKnownEndpoints)||void 0===t?void 0:t.revocationEndpoint)||(this.loggerService.logDebug("revocation endpoint not supported"),this.logoff(e)),this.storagePersistanceService.getRefreshToken()?this.revokeRefreshToken().pipe(s.switchMap((function(e){return r.revokeAccessToken(e)})),s.catchError((function(e){var t="revoke token failed "+e;return r.loggerService.logError(t),n.throwError(t)})),s.tap((function(){return r.logoff(e)}))):this.revokeAccessToken().pipe(s.catchError((function(e){var t="revoke access token failed "+e;return r.loggerService.logError(t),n.throwError(t)})),s.tap((function(){return r.logoff(e)})))},e.prototype.revokeAccessToken=function(e){var t=this,r=e||this.storagePersistanceService.accessToken,o=this.urlService.createRevocationEndpointBodyAccessToken(r),a=this.urlService.getRevocationEndpointUrl(),c=new i.HttpHeaders;return c=c.set("Content-Type","application/x-www-form-urlencoded"),this.dataService.post(a,o,c).pipe(s.switchMap((function(e){return t.loggerService.logDebug("revocation endpoint post response: ",e),n.of(e)})),s.catchError((function(e){var r="Revocation request failed "+e;return t.loggerService.logError(r),n.throwError(r)})))},e.prototype.revokeRefreshToken=function(e){var t=this,r=e||this.storagePersistanceService.getRefreshToken(),o=this.urlService.createRevocationEndpointBodyRefreshToken(r),a=this.urlService.getRevocationEndpointUrl(),c=new i.HttpHeaders;return c=c.set("Content-Type","application/x-www-form-urlencoded"),this.dataService.post(a,o,c).pipe(s.switchMap((function(e){return t.loggerService.logDebug("revocation endpoint post response: ",e),n.of(e)})),s.catchError((function(e){var r="Revocation request failed "+e;return t.loggerService.logError(r),n.throwError(r)})))},e.prototype.getEndSessionUrl=function(){var e=this.storagePersistanceService.idToken;return this.urlService.createEndSessionUrl(e)},e.ctorParameters=function(){return[{type:S},{type:C},{type:b},{type:L},{type:G},{type:$},{type:Y},{type:I}]},e=l([r.Injectable()],e)}(),Z=function(){function t(e,t,r,i,o,s,a,c,u,l){this.urlService=e,this.flowsService=t,this.flowHelper=r,this.configurationProvider=i,this.router=o,this.flowsDataService=s,this.loggerService=a,this.silentRenewService=c,this.userService=u,this.authStateService=l,this.runTokenValidationRunning=null,this.stsCallbackInternal$=new n.Subject}return Object.defineProperty(t.prototype,"stsCallback$",{get:function(){return this.stsCallbackInternal$.asObservable()},enumerable:!0,configurable:!0}),t.prototype.handlePossibleStsCallback=function(e){var t,r=this;return this.urlService.isCallbackFromSts()?this.flowHelper.isCurrentFlowCodeFlow()?t=this.authorizedCallbackWithCode(e):this.flowHelper.isCurrentFlowAnyImplicitFlow()&&(t=this.authorizedImplicitFlowCallback()):t=n.of(null),t.pipe(s.tap((function(){return r.stsCallbackInternal$.next()})))},t.prototype.startTokenValidationPeriodically=function(e){var t=this;if(!this.runTokenValidationRunning&&this.configurationProvider.openIDConfiguration.silentRenew){var r=1e3*e;this.loggerService.logDebug("starting token validation check every "+e+"s ("+r+"ms)");var i=n.interval(r).pipe(s.switchMap((function(){var e=t.authStateService.getIdToken(),r=t.flowsDataService.isSilentRenewRunning(),i=t.userService.getUserDataFromStore();if(t.loggerService.logDebug("Checking: silentRenewRunning: "+r+" id_token: "+!!e+" userData: "+!!i),!(i&&!r&&e))return n.of(null);var o=t.authStateService.hasIdTokenExpired(),s=t.authStateService.hasAccessTokenExpiredIfExpiryExists();return o||s?(t.loggerService.logDebug("IsAuthorized: id_token idTokenHasExpired, start silent renew if active"),t.configurationProvider.openIDConfiguration.silentRenew?(t.flowsDataService.setSilentRenewRunning(),t.flowHelper.isCurrentFlowCodeFlowWithRefeshTokens()?t.refreshSessionWithRefreshTokens():t.refreshSessionWithIframe()):(t.flowsService.resetAuthorizationData(),n.of(null))):n.of(null)})));this.runTokenValidationRunning=i.pipe(s.catchError((function(){return t.flowsDataService.resetSilentRenewRunning(),n.throwError("periodically check failed")}))).subscribe((function(){t.flowHelper.isCurrentFlowCodeFlowWithRefeshTokens()&&t.flowsDataService.resetSilentRenewRunning()}))}},t.prototype.stopPeriodicallTokenCheck=function(){this.scheduledHeartBeatInternal&&(clearTimeout(this.scheduledHeartBeatInternal),this.scheduledHeartBeatInternal=null,this.runTokenValidationRunning.unsubscribe(),this.runTokenValidationRunning=null)},t.prototype.authorizedCallbackWithCode=function(e){var t=this;return this.flowsService.processCodeFlowCallback(e).pipe(s.tap((function(e){t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||e.isRenewProcess||t.router.navigate([t.configurationProvider.openIDConfiguration.postLoginRoute])})),s.catchError((function(e){return t.flowsDataService.resetSilentRenewRunning(),t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||t.router.navigate([t.configurationProvider.openIDConfiguration.unauthorizedRoute]),t.stopPeriodicallTokenCheck(),n.throwError(e)})))},t.prototype.authorizedImplicitFlowCallback=function(e){var t=this;return this.flowsService.processImplicitFlowCallback(e).pipe(s.tap((function(e){t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||e.isRenewProcess||t.router.navigate([t.configurationProvider.openIDConfiguration.postLoginRoute])})),s.catchError((function(e){return t.flowsDataService.resetSilentRenewRunning(),t.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||t.router.navigate([t.configurationProvider.openIDConfiguration.unauthorizedRoute]),t.stopPeriodicallTokenCheck(),n.throwError(e)})))},t.prototype.refreshSessionWithIframe=function(){this.loggerService.logDebug("BEGIN refresh session Authorize Iframe renew");var e=this.urlService.getRefreshSessionSilentRenewUrl();return this.sendAuthorizeReqestUsingSilentRenew(e)},t.prototype.refreshSessionWithRefreshTokens=function(){var e=this;return this.loggerService.logDebug("BEGIN refresh session Authorize"),this.flowsService.processRefreshToken().pipe(s.catchError((function(t){return e.configurationProvider.openIDConfiguration.triggerAuthorizationResultEvent||e.router.navigate([e.configurationProvider.openIDConfiguration.unauthorizedRoute]),e.stopPeriodicallTokenCheck(),e.flowsService.resetAuthorizationData(),n.throwError(t)})))},t.prototype.sendAuthorizeReqestUsingSilentRenew=function(e){var t=this,r=this.silentRenewService.getOrCreateIframe();return this.initSilentRenewRequest(),this.loggerService.logDebug("sendAuthorizeReqestUsingSilentRenew for URL:"+e),new n.Observable((function(i){var n=function(){r.removeEventListener("load",n),t.loggerService.logDebug("removed event listener from IFrame"),i.next(!0),i.complete()};r.addEventListener("load",n),r.src=e}))},t.prototype.silentRenewEventHandler=function(e){var t=this;if(this.loggerService.logDebug("silentRenewEventHandler"),e.detail)if(this.flowHelper.isCurrentFlowCodeFlow()){var r=e.detail.toString().split("?");this.codeFlowCallbackSilentRenewIframe(r).subscribe((function(){t.flowsDataService.resetSilentRenewRunning()}),(function(e){t.loggerService.logError("Error: "+e),t.flowsDataService.resetSilentRenewRunning()}))}else this.authorizedImplicitFlowCallback(e.detail).subscribe((function(){t.flowsDataService.resetSilentRenewRunning()}),(function(e){t.loggerService.logError("Error: "+e),t.flowsDataService.resetSilentRenewRunning()}))},t.prototype.codeFlowCallbackSilentRenewIframe=function(t){var r=this,o=new i.HttpParams({fromString:t[1]}),a=o.get("error");if(a)return this.authStateService.updateAndPublishAuthState({authorizationState:e.AuthorizedState.Unauthorized,validationResult:e.ValidationResult.LoginRequired,isRenewProcess:!0}),this.flowsService.resetAuthorizationData(),this.flowsDataService.setNonce(""),this.stopPeriodicallTokenCheck(),n.throwError(a);var c={code:o.get("code"),refreshToken:null,state:o.get("state"),sessionState:o.get("session_state"),authResult:null,isRenewProcess:!1,jwtKeys:null,validationResult:null,existingIdToken:null};return this.flowsService.processSilentRenewCodeFlowCallback(c).pipe(s.catchError((function(e){return r.stopPeriodicallTokenCheck(),r.flowsService.resetAuthorizationData(),n.throwError(e)})))},t.prototype.initSilentRenewRequest=function(){var e=this,t=Math.random();this.silentRenewService.getOrCreateIframe(),this.boundSilentRenewEvent=this.silentRenewEventHandler.bind(this);var r=function(i){i.detail!==t&&(window.removeEventListener("oidc-silent-renew-message",e.boundSilentRenewEvent),window.removeEventListener("oidc-silent-renew-init",r))}.bind(this);window.addEventListener("oidc-silent-renew-init",r,!1),window.addEventListener("oidc-silent-renew-message",this.boundSilentRenewEvent,!1),window.dispatchEvent(new CustomEvent("oidc-silent-renew-init",{detail:t}))},t.ctorParameters=function(){return[{type:L},{type:$},{type:T},{type:I},{type:c.Router},{type:_},{type:b},{type:X},{type:U},{type:D}]},t.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new t(r.ɵɵinject(L),r.ɵɵinject($),r.ɵɵinject(T),r.ɵɵinject(I),r.ɵɵinject(c.Router),r.ɵɵinject(_),r.ɵɵinject(b),r.ɵɵinject(X),r.ɵɵinject(U),r.ɵɵinject(D))},token:t,providedIn:"root"}),t=l([r.Injectable({providedIn:"root"})],t)}(),ee=function(){function e(e,t,r,i,n,o,s,a,c,u,l,h,d,g){this.checkSessionService=e,this.silentRenewService=t,this.userService=r,this.tokenValidationService=i,this.tokenHelperService=n,this.loggerService=o,this.configurationProvider=s,this.urlService=a,this.authStateService=c,this.flowsDataService=u,this.flowsService=l,this.callbackService=h,this.logoffRevocationService=d,this.redirectService=g,this.TOKEN_REFRESH_INTERVALL_IN_SECONDS=3}return Object.defineProperty(e.prototype,"configuration",{get:function(){return this.configurationProvider.configuration},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"userData$",{get:function(){return this.userService.userData$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isAuthenticated$",{get:function(){return this.authStateService.authorized$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"checkSessionChanged$",{get:function(){return this.checkSessionService.checkSessionChanged$},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stsCallback$",{get:function(){return this.callbackService.stsCallback$},enumerable:!0,configurable:!0}),e.prototype.checkAuth=function(){var e=this;if(!this.configurationProvider.hasValidConfig())return this.loggerService.logError("Please provide a configuration before setting up the module"),n.of(!1);this.loggerService.logDebug("STS server: "+this.configurationProvider.openIDConfiguration.stsServer);var t=window.location.toString();return this.callbackService.handlePossibleStsCallback(t).pipe(s.map((function(){var t=e.authStateService.areAuthStorageTokensValid();return t&&(e.authStateService.setAuthorizedAndFireEvent(),e.userService.publishUserdataIfExists(),e.checkSessionService.isCheckSessionConfigured()&&e.checkSessionService.start(),e.callbackService.startTokenValidationPeriodically(e.TOKEN_REFRESH_INTERVALL_IN_SECONDS),e.silentRenewService.isSilentRenewConfigured()&&e.silentRenewService.getOrCreateIframe()),e.loggerService.logDebug("checkAuth completed fire events, auth: "+t),t})))},e.prototype.getToken=function(){return this.authStateService.getAccessToken()},e.prototype.getIdToken=function(){return this.authStateService.getIdToken()},e.prototype.getRefreshToken=function(){return this.authStateService.getRefreshToken()},e.prototype.getPayloadFromIdToken=function(e){void 0===e&&(e=!1);var t=this.getIdToken();return this.tokenHelperService.getPayloadFromToken(t,e)},e.prototype.setState=function(e){this.flowsDataService.setAuthStateControl(e)},e.prototype.getState=function(){return this.flowsDataService.getAuthStateControl()},e.prototype.authorize=function(e){if(this.configurationProvider.hasValidConfig())if(this.tokenValidationService.configValidateResponseType(this.configurationProvider.openIDConfiguration.responseType)){this.flowsService.resetAuthorizationData(),this.loggerService.logDebug("BEGIN Authorize OIDC Flow, no auth data");var t=e||{},r=t.urlHandler,i=t.customParams,n=this.urlService.getAuthorizeUrl(i);r?r(n):this.redirectService.redirectTo(n)}else this.loggerService.logError("Invalid response type!");else this.loggerService.logError("Well known endpoints must be loaded before user can login!")},e.prototype.logoffAndRevokeTokens=function(e){return this.logoffRevocationService.logoffAndRevokeTokens(e)},e.prototype.logoff=function(e){return this.logoffRevocationService.logoff(e)},e.prototype.logoffLocal=function(){return this.logoffRevocationService.logoffLocal()},e.prototype.revokeAccessToken=function(e){return this.logoffRevocationService.revokeAccessToken(e)},e.prototype.revokeRefreshToken=function(e){return this.logoffRevocationService.revokeRefreshToken(e)},e.prototype.getEndSessionUrl=function(){return this.logoffRevocationService.getEndSessionUrl()},e.ctorParameters=function(){return[{type:G},{type:X},{type:U},{type:A},{type:P},{type:b},{type:I},{type:L},{type:D},{type:_},{type:$},{type:Z},{type:Q},{type:Y}]},e=l([r.Injectable()],e)}(),te=function(){function e(e,t){this.configProvider=e,this.loggerService=t}return e.prototype.read=function(e){var t;if(!this.hasStorage())return this.loggerService.logDebug("Wanted to read '"+e+"' but Storage was undefined"),!1;var r=null===(t=this.getStorage())||void 0===t?void 0:t.getItem(e);return r?JSON.parse(r):(this.loggerService.logDebug("Wanted to read '"+e+"' but nothing was found"),!1)},e.prototype.write=function(e,t){if(!this.hasStorage())return this.loggerService.logDebug("Wanted to write '"+e+"/"+t+"' but Storage was falsy"),!1;var r=this.getStorage();return r?(t=t||null,r.setItem(""+e,JSON.stringify(t)),!0):(this.loggerService.logDebug("Wanted to write '"+e+"/"+t+"' but Storage was falsy"),!1)},e.prototype.getStorage=function(){var e;return null===(e=this.configProvider.openIDConfiguration)||void 0===e?void 0:e.storage},e.prototype.hasStorage=function(){return"undefined"!=typeof Storage},e.ctorParameters=function(){return[{type:I},{type:b}]},e=l([r.Injectable()],e)}(),re=function(){function e(){}return e.prototype.areEqual=function(e,t){if(!e||!t)return!1;if(this.bothValuesAreArrays(e,t))return this.arraysEqual(e,t);if(this.bothValuesAreStrings(e,t))return e===t;if(this.bothValuesAreObjects(e,t))return JSON.stringify(e).toLowerCase()===JSON.stringify(t).toLowerCase();if(this.oneValueIsStringAndTheOtherIsArray(e,t)){if(Array.isArray(e)&&this.valueIsString(t))return e[0]===t;if(Array.isArray(t)&&this.valueIsString(e))return t[0]===e}},e.prototype.oneValueIsStringAndTheOtherIsArray=function(e,t){return Array.isArray(e)&&this.valueIsString(t)||Array.isArray(t)&&this.valueIsString(e)},e.prototype.bothValuesAreObjects=function(e,t){return this.valueIsObject(e)&&this.valueIsObject(t)},e.prototype.bothValuesAreStrings=function(e,t){return this.valueIsString(e)&&this.valueIsString(t)},e.prototype.bothValuesAreArrays=function(e,t){return Array.isArray(e)&&Array.isArray(t)},e.prototype.valueIsString=function(e){return"string"==typeof e||e instanceof String},e.prototype.valueIsObject=function(e){return"object"==typeof e},e.prototype.arraysEqual=function(e,t){if(e.length!==t.length)return!1;for(var r=e.length;r--;)if(e[r]!==t[r])return!1;return!0},e=l([r.Injectable()],e)}(),ie=function(){function e(){}var i;return i=e,e.forRoot=function(e){return void 0===e&&(e={}),{ngModule:i,providers:[F,m,T,ee,A,y,G,_,$,X,I,Q,U,z,v,L,D,B,C,P,b,J,re,S,q,{provide:E,useClass:e.storage||te},{provide:K,useFactory:O,deps:[]}]}},e=i=l([r.NgModule({imports:[t.CommonModule],declarations:[],exports:[]})],e)}(),ne=function(){this.keys=[]},oe=function(){this.kty="",this.use="",this.kid="",this.x5t="",this.e="",this.n="",this.x5c=[]};e.AbstractSecurityStorage=E,e.AuthModule=ie,e.JwtKey=oe,e.JwtKeys=ne,e.LoggerService=b,e.OidcConfigService=F,e.OidcSecurityService=ee,e.PublicEventsService=m,e.StateValidationResult=M,e.TokenHelperService=P,e.TokenValidationService=A,e.ɵa=I,e.ɵb=y,e.ɵc=S,e.ɵd=v,e.ɵe=T,e.ɵf=G,e.ɵg=C,e.ɵh=J,e.ɵi=X,e.ɵj=U,e.ɵk=L,e.ɵl=O,e.ɵm=K,e.ɵn=_,e.ɵo=z,e.ɵp=D,e.ɵq=$,e.ɵr=B,e.ɵs=q,e.ɵt=Z,e.ɵu=Q,e.ɵv=Y,e.ɵw=re,e.ɵx=te,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-auth-oidc-client.umd.min.js.map